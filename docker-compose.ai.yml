version: '3.8'

services:
  nginx:
    image: nginx:alpine
    container_name: slack2teams-nginx-ai
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx-ai.conf:/etc/nginx/conf.d/default.conf:ro
      - ./images:/var/www/html/images:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - frontend
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - app-network

  frontend:
    image: laxman006/slack2teams-frontend:ai
    container_name: slack2teams-frontend-ai
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=https://ai.cloudfuze.com
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - app-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  backend:
    image: laxman006/slack2teams-backend:ai
    container_name: slack2teams-backend-ai
    environment:
      # Production environment variables
      OPENAI_API_KEY: "${OPENAI_API_KEY}"
      MICROSOFT_CLIENT_ID: "${MICROSOFT_CLIENT_ID}"
      MICROSOFT_CLIENT_SECRET: "${MICROSOFT_CLIENT_SECRET}"
      MICROSOFT_TENANT: "${MICROSOFT_TENANT}"
      LANGFUSE_PUBLIC_KEY: "${LANGFUSE_PUBLIC_KEY}"
      LANGFUSE_SECRET_KEY: "${LANGFUSE_SECRET_KEY}"
      LANGFUSE_HOST: "${LANGFUSE_HOST}"
      # MongoDB Configuration
      MONGODB_URL: "${MONGODB_URL}"
      MONGODB_DATABASE: "${MONGODB_DATABASE}"
      MONGODB_CHAT_COLLECTION: "${MONGODB_CHAT_COLLECTION}"
      MONGODB_VECTORSTORE_COLLECTION: "${MONGODB_VECTORSTORE_COLLECTION}"
      # Vectorstore Configuration
      VECTORSTORE_BACKEND: "${VECTORSTORE_BACKEND}"
      INITIALIZE_VECTORSTORE: "${INITIALIZE_VECTORSTORE}"
      # Data Sources
      ENABLE_WEB_SOURCE: "${ENABLE_WEB_SOURCE}"
      ENABLE_PDF_SOURCE: "${ENABLE_PDF_SOURCE}"
      ENABLE_EXCEL_SOURCE: "${ENABLE_EXCEL_SOURCE}"
      ENABLE_DOC_SOURCE: "${ENABLE_DOC_SOURCE}"
      ENABLE_SHAREPOINT_SOURCE: "${ENABLE_SHAREPOINT_SOURCE}"
      ENABLE_OUTLOOK_SOURCE: "${ENABLE_OUTLOOK_SOURCE}"
      # Web/Blog Configuration
      WEB_SOURCE_URL: "${WEB_SOURCE_URL}"
      WEB_START_PAGE: "${WEB_START_PAGE}"
      WEB_MAX_PAGES: "${WEB_MAX_PAGES}"
      # SharePoint Configuration
      SHAREPOINT_SITE_URL: "${SHAREPOINT_SITE_URL}"
      SHAREPOINT_START_PAGE: "${SHAREPOINT_START_PAGE}"
      SHAREPOINT_MAX_DEPTH: "${SHAREPOINT_MAX_DEPTH}"
      SHAREPOINT_EXCLUDE_FILES: "${SHAREPOINT_EXCLUDE_FILES}"
      # Outlook Configuration
      OUTLOOK_USER_EMAIL: "${OUTLOOK_USER_EMAIL}"
      OUTLOOK_FOLDER_NAME: "${OUTLOOK_FOLDER_NAME}"
      OUTLOOK_MAX_EMAILS: "${OUTLOOK_MAX_EMAILS}"
      OUTLOOK_DATE_FILTER: "${OUTLOOK_DATE_FILTER}"
      # Chunking Configuration
      CHUNK_TARGET_TOKENS: "${CHUNK_TARGET_TOKENS}"
      CHUNK_OVERLAP_TOKENS: "${CHUNK_OVERLAP_TOKENS}"
      CHUNK_MIN_TOKENS: "${CHUNK_MIN_TOKENS}"
      # Deduplication
      ENABLE_DEDUPLICATION: "${ENABLE_DEDUPLICATION}"
      DEDUP_THRESHOLD: "${DEDUP_THRESHOLD}"
      # Unstructured and OCR
      ENABLE_UNSTRUCTURED: "${ENABLE_UNSTRUCTURED}"
      ENABLE_OCR: "${ENABLE_OCR}"
      OCR_LANGUAGE: "${OCR_LANGUAGE}"
      # Graph Storage
      GRAPH_DB_PATH: "${GRAPH_DB_PATH}"
      ENABLE_GRAPH_STORAGE: "${ENABLE_GRAPH_STORAGE}"
      # Reranker Configuration
      RERANKER_SHADOW: "${RERANKER_SHADOW}"
      RERANKER_ENABLED: "${RERANKER_ENABLED}"
      VERIFIER_ENABLED: "${VERIFIER_ENABLED}"
      # File paths
      JSON_MEMORY_FILE: "/app/data/chat_history.json"
      CHROMA_DB_PATH: "/app/data/chroma_db"
      # Production settings
      PYTHONUNBUFFERED: "1"
      ENVIRONMENT: "production"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - app-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  app-network:
    driver: bridge

