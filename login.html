<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login - CF Chatbot</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: white; 
      margin: 0; 
      padding: 0;
      min-height: 100vh;
      scroll-behavior: smooth;
    }

    header {
      display: flex;
      align-items: center;
      background: white;
      width: 100%;
      padding: 10px 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    header img {
      height: 40px;
    }

    .main-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding-top: 80px; /* Space for fixed header */
      min-height: calc(100vh - 80px); /* Ensure content takes full height */
    }

    .login-container {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }

    .login-title {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
      font-weight: 600;
    }

    .login-subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
    }

    #microsoftLogin {
      background: #0078d4;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      max-width: 300px;
      margin: 0 auto;
    }

    #microsoftLogin:hover {
      background: #106ebe;
      transform: translateY(-1px);
    }

    #microsoftLogin:active {
      transform: translateY(1px);
    }

    .provider-icon {
      width: 20px;
      height: 20px;
    }

    .welcome-message {
      margin-top: 20px;
      padding: 15px;
      background: #e1ecff;
      border-radius: 10px;
      color: #333;
      font-size: 14px;
    }

    @media (max-width: 480px) {
      .login-container {
        padding: 30px 20px;
        margin: 20px;
      }
      
      .login-title {
        font-size: 24px;
      }
    }

    /* Loading animation */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <link rel="icon" type="image/png" href="./images/CloudFuze-icon-64x64.png">
</head>
<body>
  <header>
    <img src="./images/CloudFuze Horizontal Logo.svg" alt="CloudFuze Logo">
  </header>

  <div class="main-content">
    <div class="login-container">
      <h1 class="login-title">Welcome to CF Chatbot</h1>
      <p class="login-subtitle">Please sign in to continue</p>
      <button id="microsoftLogin" class="login-btn">
        <svg class="provider-icon" viewBox="0 0 24 24">
          <path fill="currentColor" d="M11.4 24H0V12.6h11.4V24zM24 24H12.6V12.6H24V24zM11.4 11.4H0V0h11.4v11.4zM24 11.4H12.6V0H24v11.4z"/>
        </svg>
        Sign in with Microsoft
      </button>
      
    </div>
  </div>

  <script>
    // Microsoft OAuth configuration - will be loaded from environment
    let MICROSOFT_CLIENT_ID = null;
    let MICROSOFT_TENANT = "cloudfuze.com"; // Restrict to CloudFuze company accounts only
    const MICROSOFT_REDIRECT_URI = window.location.origin + "/index.html";
    const MICROSOFT_SCOPE = "openid email profile User.Read";

    // API Base URL configuration
    function getApiBase() {
      // Use window.location.origin which automatically gives us the correct protocol and host
      // This works for both localhost (http://localhost:8002) and production (https://yourdomain.com)
      return window.location.origin;
    }

    // Load Microsoft OAuth configuration from backend
    async function loadOAuthConfig() {
      try {
        const response = await fetch(`${getApiBase()}/auth/config`);
        if (response.ok) {
          const config = await response.json();
          MICROSOFT_CLIENT_ID = config.client_id;
          MICROSOFT_TENANT = config.tenant || "cloudfuze.com";
          console.log('[AUTH] Loaded OAuth config:', { client_id: MICROSOFT_CLIENT_ID, tenant: MICROSOFT_TENANT });
        } else {
          throw new Error('Failed to load OAuth configuration');
        }
      } catch (error) {
        console.error('[AUTH] Error loading OAuth config:', error);
        // Fallback to hardcoded values for development
        MICROSOFT_CLIENT_ID = "861e696d-f41c-41ee-a7c2-c838fd185d6d";
        console.log('[AUTH] Using fallback client ID');
      }
    }

    // PKCE helper functions
    function generateCodeVerifier() {
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      return base64URLEncode(array);
    }

    function generateCodeChallenge(verifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(verifier);
      return crypto.subtle.digest('SHA-256', data).then(hash => {
        return base64URLEncode(new Uint8Array(hash));
      });
    }

    function base64URLEncode(array) {
      return btoa(String.fromCharCode.apply(null, Array.from(array)))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=/g, '');
    }

    // Check if user is already logged in
    function checkAuthStatus() {
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      if (user && user.access_token) {
        console.log('User found in localStorage, verifying token...');
        
        // Show loading indicator
        showLoadingIndicator('Checking authentication...');
        
        // Verify token is still valid
        verifyToken(user.access_token).then(isValid => {
          hideLoadingIndicator();
          if (isValid) {
            console.log('Token is valid, redirecting to index.html');
            // Direct redirect without success message or delay
            window.location.href = "index.html";
          } else {
            console.log('Token is invalid, clearing user data');
            localStorage.removeItem('user');
            showError('Your session has expired. Please sign in again.');
          }
        }).catch(error => {
          console.error('Token verification failed:', error);
          hideLoadingIndicator();
          localStorage.removeItem('user');
          showError('Authentication check failed. Please sign in again.');
        });
      } else {
        console.log('No user found in localStorage');
      }
    }

    // Verify Microsoft access token
    async function verifyToken(accessToken) {
      try {
        const response = await fetch('https://graph.microsoft.com/v1.0/me', {
          headers: {
            'Authorization': `Bearer ${accessToken}`
          }
        });
        return response.ok;
      } catch (error) {
        return false;
      }
    }

    // Microsoft login handler
    async function handleMicrosoftLogin(event) {
      event.preventDefault();
      
      // Check if Client ID is configured
      if (MICROSOFT_CLIENT_ID === "YOUR_MICROSOFT_CLIENT_ID") {
        showError("Please configure your Microsoft Client ID in the login.html file. Replace 'YOUR_MICROSOFT_CLIENT_ID' with your actual Azure App Client ID.");
        return;
      }
      
      // Clear any existing session data to ensure fresh login
      sessionStorage.removeItem('code_verifier');
      localStorage.removeItem('user');
      
      // Show loading state
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = '<span>Signing in...</span>';
      button.disabled = true;
      
      // Generate PKCE parameters
      const codeVerifier = generateCodeVerifier();
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      
      // Store code verifier for later use
      sessionStorage.setItem('code_verifier', codeVerifier);
      
      const authUrl = `https://login.microsoftonline.com/${MICROSOFT_TENANT}/oauth2/v2.0/authorize?` +
        `client_id=${MICROSOFT_CLIENT_ID}&` +
        `response_type=code&` +
        `redirect_uri=${encodeURIComponent(MICROSOFT_REDIRECT_URI)}&` +
        `response_mode=query&` +
        `scope=${encodeURIComponent(MICROSOFT_SCOPE)}&` +
        `prompt=select_account&` +
        `code_challenge=${codeChallenge}&` +
        `code_challenge_method=S256&` +
        `state=${Date.now()}`;
      
      try {
        window.location.href = authUrl;
      } catch (error) {
        // Restore button state on error
        button.innerHTML = originalText;
        button.disabled = false;
        showError('Failed to initiate login: ' + error.message);
      }
    }

    // Error display function
    function showError(message) {
      // Remove any existing error messages
      const existingError = document.querySelector('.error-message');
      if (existingError) {
        existingError.remove();
      }
      
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.style.cssText = `
        background: #fee;
        color: #c33;
        padding: 15px;
        border-radius: 10px;
        margin-top: 20px;
        border: 1px solid #fcc;
        font-size: 14px;
      `;
      errorDiv.innerHTML = message;
      document.querySelector('.login-container').appendChild(errorDiv);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (errorDiv.parentNode) {
          errorDiv.remove();
        }
      }, 5000);
    }

    // Success display function
    function showSuccess(message) {
      const successDiv = document.createElement('div');
      successDiv.className = 'success-message';
      successDiv.style.cssText = `
        background: #efe;
        color: #363;
        padding: 15px;
        border-radius: 10px;
        margin-top: 20px;
        border: 1px solid #cfc;
        font-size: 14px;
      `;
      successDiv.innerHTML = message;
      document.querySelector('.login-container').appendChild(successDiv);
    }

    // Loading indicator functions
    function showLoadingIndicator(message) {
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'loading-indicator';
      loadingDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 20px 30px;
        border-radius: 8px;
        z-index: 10000;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
      `;
      loadingDiv.innerHTML = `
        <div style="width: 20px; height: 20px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        ${message}
      `;
      document.body.appendChild(loadingDiv);
    }
    
    function hideLoadingIndicator() {
      const loadingDiv = document.getElementById('loading-indicator');
      if (loadingDiv) {
        loadingDiv.remove();
      }
    }


    // Handle OAuth callback
    function handleOAuthCallback() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const error = urlParams.get('error');

      if (error) {
        console.log('OAuth error:', error);
        showError('Microsoft login failed: ' + error);
        return;
      }

      if (code) {
        console.log('OAuth code received, processing...');
        exchangeCodeForToken(code);
      }
    }

    // Exchange authorization code for access token
    async function exchangeCodeForToken(code) {
      // Get code verifier from session storage
      const codeVerifier = sessionStorage.getItem('code_verifier');
      
      if (!codeVerifier) {
        console.log('Code verifier not found, starting fresh login flow...');
        // Clear any existing user data
        localStorage.removeItem('user');
        // Clear URL parameters to avoid infinite loops
        window.history.replaceState({}, document.title, window.location.pathname);
        // Show a brief message and then automatically start login
        showSuccess('Starting fresh login...');
        setTimeout(() => {
          // Automatically trigger the login button click
          const loginButton = document.getElementById('microsoftLogin');
          if (loginButton) {
            loginButton.click();
          }
        }, 1000);
        return;
      }
      
      try {
        const requestBody = {
          code: code,
          redirect_uri: MICROSOFT_REDIRECT_URI,
          code_verifier: codeVerifier
        };
        const API_BASE = getApiBase();
        const CALLBACK_URL = `${API_BASE}/auth/microsoft/callback`;

        const response = await fetch(CALLBACK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });

        if (response.ok) {
          const data = await response.json();
          
          // Clear code verifier from session storage
          sessionStorage.removeItem('code_verifier');
          
          const user = {
            id: data.user_id,
            name: data.name,
            email: data.email,
            access_token: data.access_token,
            refresh_token: data.refresh_token
          };
          
          localStorage.setItem('user', JSON.stringify(user));
          
          // Direct redirect without success message or delay
          window.location.href = "index.html";
        } else {
          const errorText = await response.text();
          console.log('Server error response:', errorText);
          
          // Check if it's a code verifier related error
          if (errorText.includes('code_verifier') || errorText.includes('Code verifier')) {
            console.log('Code verifier error detected, starting fresh login...');
            // Clear any existing user data
            localStorage.removeItem('user');
            // Clear URL parameters to avoid infinite loops
            window.history.replaceState({}, document.title, window.location.pathname);
            // Show a brief message and then automatically start login
            showSuccess('Starting fresh login...');
            setTimeout(() => {
              // Automatically trigger the login button click
              const loginButton = document.getElementById('microsoftLogin');
              if (loginButton) {
                loginButton.click();
              }
            }, 1000);
            return;
          }
          
          showError('Login failed: ' + (errorText || 'Unknown error'));
        }
      } catch (error) {
        console.log('Network or other error:', error.message);
        
        // Check if it's a code verifier related error
        if (error.message.includes('code_verifier') || error.message.includes('Code verifier')) {
          console.log('Code verifier error detected in catch, starting fresh login...');
          // Clear any existing user data
          localStorage.removeItem('user');
          // Clear URL parameters to avoid infinite loops
          window.history.replaceState({}, document.title, window.location.pathname);
          // Show a brief message and then automatically start login
          showSuccess('Starting fresh login...');
          setTimeout(() => {
            // Automatically trigger the login button click
            const loginButton = document.getElementById('microsoftLogin');
            if (loginButton) {
              loginButton.click();
            }
          }, 1000);
          return;
        }
        
        showError('Login failed: ' + error.message);
      }
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', async function() {
      // Load OAuth configuration first
      await loadOAuthConfig();
      
      // Debug information
      console.log('Login page initialized');
      console.log('Current hostname:', window.location.hostname);
      console.log('API Base URL:', getApiBase());
      
      // Add event listeners
      const microsoftButton = document.getElementById("microsoftLogin");
      
      if (microsoftButton) {
        microsoftButton.addEventListener("click", handleMicrosoftLogin);
      } else {
        console.error('Microsoft login button not found');
      }
      
      checkAuthStatus();
      handleOAuthCallback();
    });

    // Check authentication status when page becomes visible (handles browser back button)
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        console.log('Page became visible, checking auth status...');
        checkAuthStatus();
      }
    });

    // Also check when the page is focused (additional safety)
    window.addEventListener('focus', function() {
      console.log('Window focused, checking auth status...');
      checkAuthStatus();
    });

    // Check authentication on page load (handles direct navigation)
    window.addEventListener('load', function() {
      console.log('Page loaded, checking auth status...');
      checkAuthStatus();
    });
  </script>
</body>
</html>
