version: '3.8'

services:
  # Backend FastAPI service
  backend:
    build: .
    container_name: slack2teams-backend
    ports:
      - "8002:8002"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - MICROSOFT_CLIENT_ID=${MICROSOFT_CLIENT_ID}
      - MICROSOFT_CLIENT_SECRET=${MICROSOFT_CLIENT_SECRET}
      - MICROSOFT_TENANT=${MICROSOFT_TENANT}
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY}
      - LANGFUSE_HOST=${LANGFUSE_HOST:-http://localhost:3100}
      - JSON_MEMORY_FILE=${JSON_MEMORY_FILE:-data/chat_history.json}
      - MONGODB_URL=${MONGODB_URL:-mongodb://mongodb:27017}
      - MONGODB_DATABASE=${MONGODB_DATABASE:-slack2teams}
      - MONGODB_CHAT_COLLECTION=${MONGODB_CHAT_COLLECTION:-chat_histories}
    volumes:
      - ./data:/app/data
      - ./images:/app/images
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx reverse proxy and static file server
  nginx:
    image: nginx:alpine
    container_name: slack2teams-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - ./index.html:/var/www/html/index.html
      - ./login.html:/var/www/html/login.html
      - ./images:/var/www/html/images
    depends_on:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MongoDB for chat history storage
  mongodb:
    image: mongo:7.0
    container_name: slack2teams-mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_DATABASE=slack2teams
    volumes:
      - mongodb_data:/data/db
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional: Langfuse for observability (if you want to run it locally)
  langfuse:
    image: langfuse/langfuse:latest
    container_name: slack2teams-langfuse
    ports:
      - "3100:3000"
    environment:
      - DATABASE_URL=postgresql://langfuse:langfuse@postgres:5432/langfuse
      - NEXTAUTH_SECRET=your-secret-key-here
      - NEXTAUTH_URL=http://localhost:3100
    depends_on:
      - postgres
    restart: unless-stopped
    profiles:
      - observability

  # PostgreSQL for Langfuse (optional)
  postgres:
    image: postgres:15-alpine
    container_name: slack2teams-postgres
    environment:
      - POSTGRES_DB=langfuse
      - POSTGRES_USER=langfuse
      - POSTGRES_PASSWORD=langfuse
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    profiles:
      - observability

volumes:
  postgres_data:
  mongodb_data:
